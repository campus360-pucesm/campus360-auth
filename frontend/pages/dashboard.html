<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CAMPUS360</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: #f3f4f6;
            padding: 0;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h2 {
            color: var(--dark);
            margin-bottom: 4px;
        }

        .user-info p {
            color: #6b7280;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .qr-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .qr-card h3 {
            margin-bottom: 16px;
            color: var(--dark);
        }

        #qrImage {
            max-width: 100%;
            height: auto;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin: 16px 0;
        }

        .scanner-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .scanner-section h3 {
            margin-bottom: 16px;
            color: var(--dark);
        }

        .history-list {
            margin-top: 16px;
        }

        .history-item {
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item strong {
            color: var(--primary);
        }

        .history-item small {
            color: #6b7280;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        /* Credential Card Styles */
        .credential-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: white;
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 16px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .card-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .card-header p {
            margin: 4px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
            letter-spacing: 2px;
        }

        .card-body {
            display: flex;
            padding: 24px;
            gap: 20px;
        }

        .card-left {
            flex-shrink: 0;
        }

        .qr-photo {
            width: 140px;
            height: 140px;
            background: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .qr-photo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-row label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .info-row span {
            font-size: 14px;
            font-weight: 500;
        }

        .role-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px !important;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: fit-content;
        }

        .card-footer {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            text-align: center;
        }

        .card-footer small {
            font-size: 11px;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <div class="header">
            <div class="user-info">
                <h2 id="userName">Cargando...</h2>
                <p id="userEmail"></p>
            </div>
            <button class="btn btn-primary btn-small" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>

        <div class="grid">
            <!-- Digital Credential Card -->
            <div class="credential-card" id="credentialCard" style="display: none;">
                <div class="card-header">
                    <h3>üéì CAMPUS360</h3>
                    <p>CREDENCIAL DIGITAL</p>
                </div>
                <div class="card-body">
                    <div class="card-left">
                        <div class="qr-photo">
                            <img id="qrImage" src="" alt="QR Code">
                        </div>
                    </div>
                    <div class="card-right">
                        <div class="info-row">
                            <label>Nombre:</label>
                            <span id="cardName">-</span>
                        </div>
                        <div class="info-row">
                            <label>Email:</label>
                            <span id="cardEmail">-</span>
                        </div>
                        <div class="info-row">
                            <label>Rol:</label>
                            <span id="cardRole" class="role-badge">-</span>
                        </div>
                        <div class="info-row">
                            <label>ID:</label>
                            <span id="cardId" style="font-family: monospace; font-size: 11px;">-</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small>V√°lido para identificaci√≥n en todo el campus</small>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="qr-card" id="generateCard">
                <h3>üì± Mi Credencial Digital</h3>
                <p>Genera tu carnet digital con c√≥digo QR</p>
                <button class="btn btn-primary" onclick="loadQRCredential()">
                    ‚ú® Generar Credencial
                </button>
            </div>

            <div class="scanner-section">
                <h3>üìç Escanear Ubicaci√≥n</h3>
                <p style="margin-bottom: 20px;">Para registrar tu acceso a un lugar, escanea el c√≥digo QR de la
                    ubicaci√≥n</p>

                <!-- Camera Scanner -->
                <div id="qr-reader" style="width: 100%; margin-top: 16px; display: none;"></div>

                <div id="scannerInstructions"
                    style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0; color: #1e40af; font-size: 14px;">
                        <strong>üì± Instrucciones:</strong><br>
                        1. Presiona el bot√≥n "Abrir C√°mara"<br>
                        2. Permite el acceso a la c√°mara cuando el navegador lo solicite<br>
                        3. Apunta la c√°mara al c√≥digo QR de la ubicaci√≥n<br>
                        4. El acceso se registrar√° autom√°ticamente
                    </p>
                </div>

                <button id="startScanBtn" class="btn btn-primary" onclick="startScanner()"
                    style="margin-top: 0; font-size: 16px; padding: 16px;">
                    üì∑ Abrir C√°mara para Escanear
                </button>
                <button id="stopScanBtn" class="btn btn-secondary" onclick="stopScanner()"
                    style="margin-top: 16px; display: none; font-size: 16px; padding: 16px;">
                    ‚ùå Cerrar C√°mara
                </button>

                <div id="scanStatus"
                    style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; display: none;">
                    <p style="margin: 0; color: #92400e; font-size: 14px;">
                        <strong>‚è≥ C√°mara activa...</strong> Apunta al c√≥digo QR de la ubicaci√≥n
                    </p>
                </div>
            </div>
        </div>

        <div class="scanner-section" style="margin-top: 24px;">
            <h3>üìã Historial de Accesos</h3>
            <div id="historyList" class="history-list">
                <p style="color: #6b7280;">Cargando historial...</p>
            </div>
        </div>
    </div>

    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        requireAuth();

        let html5QrCode = null;
        let isScanning = false;

        // Load user data
        const user = getUser();
        document.getElementById('userName').textContent = user.full_name;
        document.getElementById('userEmail').textContent = user.email;

        // Start QR Scanner
        async function startScanner() {
            if (isScanning) return;

            const qrReader = document.getElementById('qr-reader');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const instructions = document.getElementById('scannerInstructions');
            const scanStatus = document.getElementById('scanStatus');

            qrReader.style.display = 'block';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            instructions.style.display = 'none';
            scanStatus.style.display = 'block';

            html5QrCode = new Html5Qrcode("qr-reader");

            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, // C√°mara trasera
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    onScanError
                );
                isScanning = true;
                showAlert('üì∑ C√°mara activada. Apunta al c√≥digo QR', 'success');
            } catch (err) {
                showAlert('‚ùå Error al acceder a la c√°mara. Verifica los permisos: ' + err, 'error');
                stopScanner();
            }
        }

        // Stop QR Scanner
        async function stopScanner() {
            if (!isScanning || !html5QrCode) return;

            try {
                await html5QrCode.stop();
                html5QrCode.clear();
            } catch (err) {
                console.error('Error stopping scanner:', err);
            }

            const qrReader = document.getElementById('qr-reader');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const instructions = document.getElementById('scannerInstructions');
            const scanStatus = document.getElementById('scanStatus');

            qrReader.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            instructions.style.display = 'block';
            scanStatus.style.display = 'none';
            isScanning = false;
        }

        // On QR Code Detected
        async function onScanSuccess(decodedText, decodedResult) {
            // Stop scanner
            await stopScanner();

            // Auto-submit
            showAlert(`QR detectado: ${decodedText}. Registrando...`, 'success');
            await registerAccess(decodedText);
        }

        function onScanError(errorMessage) {
            // Ignore scan errors (they happen constantly while scanning)
        }

        // Register access to location
        async function registerAccess(locationCode) {
            try {
                const response = await apiRequest('/qr/scan', {
                    method: 'POST',
                    body: JSON.stringify({
                        location_code: locationCode
                    })
                });

                const data = await response.json();
                showAlert(`‚úÖ Acceso registrado en ${data.location_code}`, 'success');
                loadHistory();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Load QR credential
        async function loadQRCredential() {
            try {
                const response = await apiRequest(`/admin/qr/generate-credential/${user.id}`);
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                // Set QR image
                const qrImage = document.getElementById('qrImage');
                qrImage.src = imageUrl;

                // Populate card data
                document.getElementById('cardName').textContent = user.full_name;
                document.getElementById('cardEmail').textContent = user.email;
                document.getElementById('cardRole').textContent = user.role;
                document.getElementById('cardId').textContent = user.id;

                // Show credential card, hide generate button
                document.getElementById('credentialCard').style.display = 'block';
                document.getElementById('generateCard').style.display = 'none';

                showAlert('‚úÖ Credencial generada exitosamente', 'success');
            } catch (error) {
                showAlert('Error al generar credencial: ' + error.message, 'error');
            }
        }


        // Load access history
        async function loadHistory() {
            try {
                const response = await apiRequest('/qr/history?limit=10');
                const history = await response.json();

                const historyList = document.getElementById('historyList');

                if (history.length === 0) {
                    historyList.innerHTML = '<p style="color: #6b7280;">No hay accesos registrados</p>';
                    return;
                }

                historyList.innerHTML = history.map(item => `
                    <div class="history-item">
                        <div>
                            <strong>${item.location_code}</strong>
                        </div>
                        <small>${formatDate(item.timestamp)}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Logout
        function logout() {
            clearAuth();
            window.location.href = '../index.html';
        }

        // Load history on page load
        loadHistory();
    </script>
</body>

</html>