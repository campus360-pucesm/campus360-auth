// Prisma Schema for CAMPUS360 Authentication Module
// Database: Supabase (PostgreSQL)

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model - Stores registered users
model User {
  id            String      @id @default(uuid())
  email         String      @unique
  password_hash String
  full_name     String
  role          String      @default("student")
  created_at    DateTime    @default(now())
  access_logs   AccessLog[]
  locations     Location[]  @relation("CreatedLocations")

  @@map("users")
}

// Location Model - Stores QR locations with geolocation and time constraints
model Location {
  id            String      @id @default(uuid())
  location_code String      @unique
  location_name String?
  latitude      Float
  longitude     Float
  class_start   DateTime
  class_end     DateTime
  grace_period  Int         @default(15) // minutes
  created_by    String
  created_at    DateTime    @default(now())
  
  creator       User        @relation("CreatedLocations", fields: [created_by], references: [id], onDelete: Cascade)
  access_logs   AccessLog[]

  @@map("locations")
}

// AccessLog Model - Tracks location access via QR scanning with validation
model AccessLog {
  id              Int       @id @default(autoincrement())
  user_id         String
  location_id     String?
  location_code   String    // Kept for backward compatibility
  timestamp       DateTime  @default(now())
  
  // Validation fields
  status          String?   // "ON_TIME", "LATE", "ABSENT", "INVALID_LOCATION", "EXPIRED"
  user_latitude   Float?
  user_longitude  Float?
  distance_meters Float?    // Calculated distance from location
  
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  location        Location? @relation(fields: [location_id], references: [id], onDelete: SetNull)

  @@map("access_logs")
}
